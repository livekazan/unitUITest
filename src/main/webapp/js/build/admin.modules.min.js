"use strict";function errorRequest(){$("#alertModal").modal("show")}var view404=angular.module("catiApp.view404",["ngRoute"]);view404.config(["$routeProvider",function(a){a.when("/404",{templateUrl:"view404/view404.html",controller:"Ctrl404"})}]),view404.controller("Ctrl404",[,function(){}]);var viewCurrent=angular.module("catiApp.viewCurrent",["highcharts-ng"]).config(["$routeProvider",function(a){a.when("/current",{templateUrl:"viewAdmin/viewCurr/viewCurrent.html",controller:"ViewCurrentCtrl"})}]);viewCurrent.controller("ViewCurrentCtrl",["$scope","$rootScope","currService","ngTableParams",function(a,b,c){a.currPollPage=-1,a.currTest={},a.currPoll={},a.currQuestion={},a.initializeTest=function(d){c.getTest(d).success(function(c){c&&c.result||b.dialogAlertOpen();var d=angular.fromJson(c.result);d.errorMessage?b.dialogAlertOpen(d.errorMessage):a.currTest=d})},(a.initializeInterview=function(d){return b.viewReviewId=d||b.viewReviewId,b.viewReviewId?"/current"!=b.getLocationPath()?void b.setLocationPath("/current"):(a.viewReviewId=d||b.viewReviewId,void c.getInterview(a.viewReviewId).success(function(c){c&&c.result||b.dialogAlertOpen();var d=angular.fromJson(c.result);d.errorMessage?b.dialogAlertOpen(d.errorMessage):(a.currPoll=d,a.currPollPage=-1,a.chartConfigSexInit(),a.chartConfigAgeMaleInit(),a.chartConfigAgeFemaleInit(),a.initializeTest(a.currPoll.testId))})):void b.setLocationPath("/main")})(),a.$watch("currPollPage",function(b){b>=0&&(a.currQuestion=a.currTest.questions[b])}),a.startQuestion=function(){a.currPollPage=0},a.endQuestion=function(){a.currPollPage=-1},a.prevQuestion=function(){a.currPollPage>0&&a.currPollPage--},a.nextQuestion=function(){a.currPollPage<a.currTest.questions.length-1&&(a.currPollPage=a.answerNextPage?a.answerNextPage-1:a.currPollPage+1,a.answerNextPage=null)},a.pickAnswerNextPage=function(b){a.answerNextPage=b},a.chartConfigSexInit=function(){a.chartConfigSex.series=[];var b=a.currPoll.quotaPlanTemplateJSON.totalNumber;a.chartConfigSex.title.text="";var c=[{name:"Женщины",y:Math.round(parseFloat(b*a.currPoll.quotaPlanTemplateJSON.femalePercent/100))},{name:"Мужчины",y:Math.round(parseFloat(b*a.currPoll.quotaPlanTemplateJSON.malePercent/100))}];a.chartConfigSex.series.push({name:"Количество",dataLabels:{enabled:!1},data:c})},a.chartConfigAgeMaleInit=function(){a.chartConfigAgeMale.series=[],a.chartConfigAgeMale.title.text="";for(var b=a.currPoll.quotaPlanTemplateJSON.totalNumber,c=a.currPoll.quotaPlanTemplateJSON.quotaTemplateJSONs,d=Math.round(parseFloat(b*a.currPoll.quotaPlanTemplateJSON.malePercent/100)),e=[],f=0;f<c.length;f++)if("male"==c[f].sex){var g={name:c[f].beginAge+" - "+c[f].endAge+" лет",y:Math.round(parseFloat(d*c[f].percent/100))};e.push(g)}a.chartConfigAgeMale.series.push({name:"Количество",dataLabels:{enabled:!1},data:e})},a.chartConfigAgeFemaleInit=function(){a.chartConfigAgeFemale.series=[],a.chartConfigAgeFemale.title.text="";for(var b=a.currPoll.quotaPlanTemplateJSON.totalNumber,c=a.currPoll.quotaPlanTemplateJSON.quotaTemplateJSONs,d=Math.round(parseFloat(b*a.currPoll.quotaPlanTemplateJSON.femalePercent/100)),e=[],f=0;f<c.length;f++)if("female"==c[f].sex){var g={name:c[f].beginAge+" - "+c[f].endAge+" лет",y:Math.round(parseFloat(d*c[f].percent/100))};e.push(g)}a.chartConfigAgeFemale.series.push({name:"Количество",dataLabels:{enabled:!1},data:e})},a.removeInterviewFromList=function(c){b.viewReviews.splice(c,1),b.viewReviewId=b.viewReviews.length?b.viewReviews[0].id:0,a.initializeInterview()},a.getTextClass=function(b){return"text-"+a.getTypeClass(b)},a.getTypeClass=function(a){var b={isEdited:"info",isRunning:"success",isEnded:"danger"};return b[a]||"info"},b.initializeInterview=a.initializeInterview,b.removeInterviewFromList=a.removeInterviewFromList,a.chartConfigSex={options:{chart:{type:"pie"},plotOptions:{pie:{colors:function(){var a=[],b="#428bca",c="#d9534f";return a.push(Highcharts.Color(c).brighten(0).get()),a.push(Highcharts.Color(b).brighten(0).get()),a}()}}},series:[],title:{},loading:!1},a.chartConfigAgeMale={options:{chart:{type:"pie"},plotOptions:{pie:{colors:function(){{var a,b=[];Highcharts.getOptions().colors[0]}for(a=0;10>a;a+=1)b.push(Highcharts.Color("#428bca").brighten((a-1)/10).get());return b}()}}},series:[],title:{},loading:!1},a.chartConfigAgeFemale={options:{chart:{type:"pie"},plotOptions:{pie:{colors:function(){{var a,b=[];Highcharts.getOptions().colors[3]}for(a=0;10>a;a+=1)b.push(Highcharts.Color("#d9534f").brighten((a-1)/10).get());return b}()}}},series:[],title:{},loading:!1}}]),viewCurrent.service("currService",["$http",function(a){function b(a){var b="getTest",c={testId:a};return d(b,c)}function c(a){var b="getInterview",c={interviewId:a};return d(b,c)}function d(b,c){var d={method:"POST",url:b,params:c},e=a(d);return e.error(errorRequest),e}return{getTest:b,getInterview:c}}]);var viewMain=angular.module("catiApp.viewImport",[]).config(["$routeProvider",function(a){a.when("/import",{templateUrl:"viewAdmin/viewImport/viewImport.html",controller:"ViewImportCtrl"})}]);viewMain.controller("ViewImportCtrl",["$scope","$rootScope","importService","appService",function(a,b,c,d){a.modal={},a.modal.city=$("#newCityModal"),(a.getAllCity=function(){d.getProperties(5).success(function(c){c&&c.result||b.dialogAlertOpen(),a.cityList=angular.fromJson(c.result),a.cityTemp=a.cityList[0]})})(),a.deleteCity=function(){b.dialogConfirmOpen("Вы уверены, что хотите удалить телефонную базу?",function(){c.deleteCity(a).success(function(c){c&&c.result||b.dialogAlertOpen(),a.getAllCity()})})},a.addCity=function(){c.addCity(a).success(function(c){c&&c.result||b.dialogAlertOpen(),a.getAllCity(),a.modal.city.modal("hide")})},a.importContacts=function(){b.dialogWaitingOpen("Подождите, идет загрузка контактов в систему...","Импортирование завершено"),c.importContacts(a).success(function(a){a&&a.result||b.dialogAlertOpen(),b.setWaitingFinish(a.result)})}}]),viewMain.directive("fileModel",["$parse",function(a){return{restrict:"A",link:function(b,c,d){var e=a(d.fileModel),f=e.assign;c.bind("change",function(){b.$apply(function(){f(b,c[0].files[0])})})}}}]),viewMain.service("importService",["$http",function(a){function b(b){var c="importContacts",d={};d.cityId=b.cityTemp.index;var e=new FormData;e.append("excelFile",b.excelFile),e.append("cityId",b.cityTemp.index);var f=a.post(c,e,{transformRequest:angular.identity,headers:{"Content-Type":void 0}});return f.error(errorRequest),f}function c(a){var b="addCity",c={};return c.cityName=a.cityName,e(b,c)}function d(a){var b="deleteCity",c={};return c.cityId=a.cityTemp.index,e(b,c)}function e(b,c,d){var e={method:"POST",url:b,params:c,data:d},f=a(e);return f.error(errorRequest),f}return{addCity:c,deleteCity:d,importContacts:b}}]);var viewMain=angular.module("catiApp.viewMain",[]).config(["$routeProvider",function(a){a.when("/main",{templateUrl:"viewAdmin/viewMain/viewMain.html",controller:"ViewMainCtrl"})}]);viewMain.controller("ViewMainCtrl",["$rootScope","$scope","mainService",function(a,b,c){b.stat={},(b.getMainStat=function(){c.getMainStat().success(function(c){c&&c.result||a.dialogAlertOpen();var d=angular.fromJson(c.result);d.errorMessage?a.dialogAlertOpen(d.errorMessage):(b.stat=d,b.chartConfigCityInit(),b.chartConfigPollInit())})})(),b.chartConfigCityInit=function(){b.chartConfigCity.series=[],b.chartConfigCity.title.text="";var a=(b.stat.contactsCount,b.stat.contacts),c=[];$.each(a,function(a,b){var d={name:a,y:Math.round(parseFloat(b))};c.push(d)}),b.chartConfigCity.series.push({name:"Количество",dataLabels:{enabled:!0},data:c})},b.chartConfigCity={options:{chart:{type:"pie",width:400,height:150}},series:[],title:{},loading:!1},b.chartConfigPollInit=function(){b.chartConfigPoll.series=[],b.chartConfigPoll.title.text="";var a=b.stat.interviews,c=[];b.chartConfigPoll.xAxis={},b.chartConfigPoll.xAxis.categories=[],$.each(a,function(a,d){var e={name:a,y:Math.round(parseFloat(d))};c.push(e),b.chartConfigPoll.xAxis.categories.push(a)}),b.chartConfigPoll.series.push({name:"Количество",showInLegend:!1,dataLabels:{enabled:!1},data:c})},b.chartConfigPoll={options:{chart:{type:"column",width:400,height:150}},series:[],title:{},yAxis:{title:{text:"Кол-во"}},loading:!1}}]),viewMain.service("mainService",["$http",function(a){function b(){var a="getMainStat";return c(a)}function c(b,c){var d={method:"POST",url:b,params:c},e=a(d);return e.error(errorRequest),e}return{getMainStat:b}}]);var viewPoll=angular.module("catiApp.viewPoll",[]).config(["$routeProvider",function(a){a.when("/poll",{templateUrl:"viewAdmin/viewPoll/viewPoll.html",controller:"ViewPollCtrl"})}]);viewPoll.controller("ViewPollCtrl",["$scope","$rootScope","pollService","testService","userService","appService","ngTableParams",function(a,b,c,d,e,f,g){a.isView=!1,a.pollTab=0,a.quoteTab=0,a.pollList=[],a.testList=[],a.cityList=[],a.format="dd.MM.yyyy",a.sliders={},a.sliders.sliderValue=0,a.modal={},a.modal.poll=$("#newPollModal"),a.modal.test=$("#pickTestModal"),a.modal.city=$("#pickCityModal"),a.modal.user=$("#pickUserModal"),(a.getAllInterviews=function(){c.getAllInterviews().success(function(c){c&&c.result||b.dialogAlertOpen(),a.pollList=angular.fromJson(c.result)})})(),(a.clearPoll=function(){a.pollTemp={},a.pollTemp.userJSONList=[],a.pollTemp.quotaPlanTemplateJSON={},a.pollTemp.quotaPlanTemplateJSON.quotaTemplateJSONs=[],a.pollTemp.quotaPlanTemplateJSON.malePercent=50,a.pollTemp.quotaPlanTemplateJSON.femalePercent=50})(),(a.getAllTests=function(){d.getAllTests("isConfirm").success(function(c){c&&c.result||b.dialogAlertOpen(),a.testList=angular.fromJson(c.result)})})(),(a.getAllCity=function(){f.getProperties(5).success(function(c){c&&c.result||b.dialogAlertOpen(),a.cityList=angular.fromJson(c.result)})})(),a.newPoll=function(){a.clearPoll(),a.sliders.sliderValue=50,a.modal.poll.modal("show")},a.pickTest=function(b){a.pollTemp.testId=b.id,a.pollTemp.testName=b.name,a.modal.test.modal("hide")},a.pickCity=function(b){a.pollTemp.cityId=b.index,a.pollTemp.cityName=b.name,a.modal.city.modal("hide")},a.openTestChange=function(){a.modal.test.modal("show")},a.openCityChange=function(){a.modal.city.modal("show")},a.pickUser=function(){e.addUser(a).success(function(c){c&&c.result||b.dialogAlertOpen();var d=angular.fromJson(c.result);d.errorMessage?b.dialogAlertOpen(d.errorMessage):(a.userTemp=d,a.pollTemp.userJSONList.push(angular.copy(a.userTemp)),a.userTemp={},a.modal.user.modal("hide"))})},a.addInterview=function(){c.addInterview(a).success(function(c){c&&c.result||b.dialogAlertOpen();var d=angular.fromJson(c.result);d.errorMessage?b.dialogAlertOpen(d.errorMessage):(a.getAllInterviews(),a.modal.poll.modal("hide"))})},a.pickUserOpen=function(){a.modal.user.modal("show")},a.removeUser=function(c,d){b.dialogConfirmOpen("Вы уверены, что хотите удалить интервьюера?",function(){e.removeUser(c).success(function(c){c&&c.result||b.dialogAlertOpen();var e=angular.fromJson(c.result);e.errorMessage?b.dialogAlertOpen(e.errorMessage):a.pollTemp.userJSONList.splice(d,1)})})},a.addMale=function(){var b={};b.beginAge=a.maleBeginTemp,b.endAge=a.maleEndTemp,b.percent=0,b.sex="male",a.pollTemp.quotaPlanTemplateJSON.quotaTemplateJSONs.push(b),a.maleBeginTemp="",a.maleEndTemp=""},a.addFemale=function(){var b={};b.beginAge=a.femaleBeginTemp,b.endAge=a.femaleEndTemp,b.percent=0,b.sex="female",a.pollTemp.quotaPlanTemplateJSON.quotaTemplateJSONs.push(b),a.femaleBeginTemp="",a.femaleEndTemp=""},a.removeQuoteAge=function(b){a.pollTemp.quotaPlanTemplateJSON.quotaTemplateJSONs.splice(b,1)},a.savePoll=function(){a.pollList.push(angular.copy(a.pollTemp)),a.modal.poll.modal("hide")},a.calculateSumPercent=function(b){for(var c=0,d=0,e=a.pollTemp.quotaPlanTemplateJSON.quotaTemplateJSONs,f=0;f<e.length;f++)"male"==e[f].sex&&(c+=parseFloat(e[f].percent)),"female"==e[f].sex&&(d+=parseFloat(e[f].percent));return b?c:d},a.getBtnGroupClass=function(b){return"btn-"+a.getTypeClass(b)},a.getAlertClass=function(b){return"alert-"+a.getTypeClass(b)},a.getTypeClass=function(a){var b={isEdited:"info",isRunning:"success",isEnded:"danger"};return b[a]||"info"},a.editPoll=function(d){c.getInterview(d).success(function(c){c&&c.result||b.dialogAlertOpen(),a.pollTemp=angular.fromJson(c.result),a.sliders.sliderValue=parseFloat(a.pollTemp.quotaPlanTemplateJSON.malePercent),a.modal.poll.modal("show")})},a.exportResults=function(a){c.exportResults(a)},a.runInterview=function(d){b.dialogConfirmOpen("Вы уверены, что хотите запустить опрос?",function(){c.runInterview(d).success(function(c){c&&c.result||b.dialogAlertOpen();var d=angular.fromJson(c.result);d.errorMessage?b.dialogAlertOpen(d.errorMessage):a.getAllInterviews()})})},a.endInterview=function(d){b.dialogConfirmOpen("Вы уверены, что хотите остановить опрос?",function(){c.endInterview(d).success(function(c){c&&c.result||b.dialogAlertOpen();var d=angular.fromJson(c.result);d.errorMessage?b.dialogAlertOpen(d.errorMessage):a.getAllInterviews()})})},a.viewInterview=function(a){b.dialogConfirmOpen("Перейти к тестовому просмотру опроса?",function(){b.findJsonObjectsFirstLevel(b.viewReviews,"id",a.id).length<=0&&b.viewReviews.push(a),b.viewReviewId=a.id,b.setLocationPath("/current")})},a.deleteInterview=function(d){b.dialogConfirmOpen("Вы уверены, что хотите удалить опрос?",function(){c.deleteInterview(d).success(function(c){c&&c.result||b.dialogAlertOpen();var d=angular.fromJson(c.result);d.errorMessage?b.dialogAlertOpen(d.errorMessage):a.getAllInterviews()})})},a.tablePollParams=new g({page:1,count:10},{total:a.pollList.length,getData:function(b,c){a.tablePollParams.total(a.pollList.length),b.resolve(a.pollList.slice((c.page()-1)*c.count(),c.page()*c.count()))}}),a.tablePollParams.settings().$scope=a,a.$watchCollection("pollList",function(b){b&&a.tablePollParams.reload()}),a.tableUserParams=new g({page:1,count:5},{total:a.pollTemp.userJSONList.length,getData:function(b,c){a.tableUserParams.total(a.pollTemp.userJSONList.length),b.resolve(a.pollTemp.userJSONList.slice((c.page()-1)*c.count(),c.page()*c.count()))}}),a.tableUserParams.settings().$scope=a,a.$watchCollection("pollTemp.userJSONList",function(b){b&&a.tableUserParams.reload()}),a.tableTestParams=new g({page:1,count:10},{total:a.testList.length,getData:function(b,c){a.tableTestParams.total(a.testList.length),b.resolve(a.testList.slice((c.page()-1)*c.count(),c.page()*c.count()))}}),a.tableTestParams.settings().$scope=a,a.$watchCollection("testList",function(b){b&&a.tableTestParams.reload()}),a.tableCityParams=new g({page:1,count:10},{total:a.cityList.length,getData:function(b,c){a.tableCityParams.total(a.cityList.length),b.resolve(a.cityList.slice((c.page()-1)*c.count(),c.page()*c.count()))}}),a.tableCityParams.settings().$scope=a,a.$watchCollection("cityList",function(b){b&&a.tableCityParams.reload()}),a.dateOptions={formatYear:"yy",showWeeks:!1,startingDay:1},a.openS=function(b){b.preventDefault(),b.stopPropagation(),a.openedS=!0},a.openE=function(b){b.preventDefault(),b.stopPropagation(),a.openedE=!0},a.testOptions={min:0,max:100,step:1},a.percentFormater=function(a){return a+"%"},a.$watchCollection("sliders",function(b){a.pollTemp&&a.pollTemp.quotaPlanTemplateJSON&&(a.pollTemp.quotaPlanTemplateJSON.malePercent=parseFloat(b.sliderValue),a.pollTemp.quotaPlanTemplateJSON.femalePercent=100-parseFloat(b.sliderValue))}),a.$watchCollection("pollTemp",function(b){null!=b&&(a.isView=b.interviewState&&"isEdited"!=b.interviewState)})}]),viewPoll.service("pollService",["$http",function(a){function b(a){var b="addInterview",c={json:a.pollTemp};return j(b,null,c)}function c(a){var b="exportResults",c="interviewId="+a;return i(b,c)}function d(a){var b="getInterview",c={interviewId:a};return j(b,c)}function e(a){var b="runInterview",c={interviewId:a};return j(b,c)}function f(a){var b="endInterview",c={interviewId:a};return j(b,c)}function g(a){var b="deleteInterview",c={interviewId:a};return j(b,c)}function h(a){a=a||"all";var b="getAllInterviews",c={interviewState:a};return j(b,c)}function i(a,b){window.location=a+"?"+b}function j(b,c,d){var e={method:"POST",url:b,params:c,data:d},f=a(e);return f.error(errorRequest),f}return{addInterview:b,getInterview:d,runInterview:e,endInterview:f,exportResults:c,deleteInterview:g,getAllInterviews:h}}]);var viewTest=angular.module("catiApp.viewTest",[]).config(["$routeProvider",function(a){a.when("/test",{templateUrl:"viewAdmin/viewTest/viewTest.html",controller:"ViewTestCtrl"})}]);viewTest.controller("ViewTestCtrl",["$scope","$rootScope","testService","appService","ngTableParams",function(a,b,c,d,e){var f=$("#toggleTest");a.testTab=0,a.askNameTemp="",a.isView=!1,a.isDeleted=!1,a.documentStateFirst=!1,a.questionTypes=[],a.testList=[],a.testTemp={},a.questionTemp={},a.modal={},a.modal.test=$("#newTestModal"),a.modal.question=$("#newAskModal"),(a.clearQuestion=function(){a.questionTemp={},a.questionTypeTemp=a.questionTemp.questionType,a.questionTemp.answers=[]})(),(a.clearTest=function(){a.testTemp={},a.testTemp.documentState="Черновик",a.testTemp.questions=[]})(),(a.getAllTests=function(){c.getAllTests().success(function(c){c&&c.result||b.dialogAlertOpen(),a.testList=angular.fromJson(c.result)})})(),(a.getAllCity=function(){d.getProperties(2).success(function(c){c&&c.result||b.dialogAlertOpen(),a.questionTypes=angular.fromJson(c.result),a.questionTypeTemp=a.questionTypes[0]})})(),a.tableTestParams=new e({page:1,count:10},{total:a.testList.length,getData:function(b,c){a.tableTestParams.total(a.testList.length),b.resolve(a.testList.slice((c.page()-1)*c.count(),c.page()*c.count()))}}),a.tableTestParams.settings().$scope=a,a.tableQuestionParams=new e({page:1,count:3},{total:a.testTemp.questions.length,getData:function(b,c){a.tableQuestionParams.total(a.testTemp.questions.length),b.resolve(a.testTemp.questions.slice((c.page()-1)*c.count(),c.page()*c.count()))}}),a.tableQuestionParams.settings().$scope=a,a.addAsk=function(b){if(b=b||!1,a.isAge){var c=a.askAgeEndTemp<100?a.askAgeBeginTemp+" - "+a.askAgeEndTemp+" лет":a.askAgeBeginTemp+" и старше",d={name:c};return a.questionTemp.answers.push(d),a.askAgeBeginTemp="",void(a.askAgeEndTemp="")}var d={name:a.askNameTemp,notRead:b};a.questionTemp.answers.push(d),a.askNameTemp=""},a.removeTest=function(d,e){e.stopPropagation(),b.dialogConfirmOpen("Вы уверены, что хотите удалить анкету?",function(){c.deleteTest(d).success(function(c){c&&c.result||b.dialogAlertOpen();var d=angular.fromJson(c.result);d.errorMessage?b.dialogAlertOpen(d.errorMessage):a.getAllTests()})})},a.revertEditTest=function(d){var e=a.testTemp.id;e&&(b.dialogWaitingOpen(),c.revertEditTest(e,!d).success(function(c){c&&c.result||b.dialogAlertOpen();var d=angular.fromJson(c.result);d.errorMessage?(f.bootstrapSwitch("state",!1),b.dialogAlertOpen(d.errorMessage)):(a.testTemp=d,a.getAllTests()),b.dialogWaitingClose()}))},a.removeQuestion=function(c,d){d.stopPropagation(),b.dialogConfirmOpen("Вы уверены, что хотите удалить вопрос?",function(){a.testTemp.questions[c].deleted=!0})},a.removeAsk=function(b){a.questionTemp.answers[b].deleted=!0},a.questionAnswersLength=function(a){for(var b=0,c=a.answers.length,d=0;c>d;d++)a.answers[d].deleted||b++;return b},a.newTest=function(){a.clearTest(),a.testTab=0,f.bootstrapSwitch("state",!0),a.modal.test.modal("show")},a.newQuestion=function(){a.clearQuestion(),a.questionTypeTemp=a.questionTypes[0],a.modal.question.modal("show")},a.editQuestion=function(c){a.questionTemp=angular.copy(c),a.questionTypeTemp=b.findJsonObjects(a.questionTypes,"index",a.questionTemp.questionType)[0],a.modal.question.modal("show")},a.editTest=function(b){a.testTab=0,a.testTemp=angular.copy(b);var c="Черновик"==a.testTemp.documentState;a.documentStateFirst=f.bootstrapSwitch("state")!=c,f.bootstrapSwitch("state",c),a.modal.test.modal("show")},a.saveQuestion=function(){a.questionTemp.questionType=a.questionTypeTemp.index,a.questionTemp.questionTypeStr=a.questionTypeTemp.name;var c=angular.copy(a.questionTemp);if(c.indexOrder){var d=b.findJsonObjectsFirstLevel(a.testTemp.questions,"indexOrder",a.questionTemp.indexOrder)[0],e=a.testTemp.questions.indexOf(d);e>=0&&(a.testTemp.questions[e]=c)}else{var f=a.testTemp.questions.length;c.indexOrder=f+1,a.testTemp.questions.push(c)}a.modal.question.modal("hide"),a.modal.test.modal("show")},a.saveTest=function(){a.testTemp.documentState=f.bootstrapSwitch("state")?"Черновик":"Завершен",c.addTest(a).success(function(c){c&&c.result||b.dialogAlertOpen();var d=angular.fromJson(c.result);d.errorMessage?b.dialogAlertOpen(d.errorMessage):(a.testTemp=d,a.getAllTests())})},a.saveTestAndClose=function(){a.saveTest(),a.modal.test.modal("hide")},a.cutText=function(a){var b=40,c=a.length<b?a.length:b,d=a.length<b?"":"...";return a.substring(0,c)+d},a.$watchCollection("testTemp.questions",function(b){b&&a.tableQuestionParams.reload()}),a.$watchCollection("testList",function(b){b&&a.tableTestParams.reload()}),a.$watch("testTemp.documentState",function(b){b&&(a.isView="Черновик"!=b,a.isDeleted="Удален"==b)}),a.$watch("questionTypeTemp",function(b){b&&(a.isSex=!1,a.isAge=!1,"sex"==b.index&&(a.questionTemp.answers=[],a.questionTemp.answers.push({name:"Мужской"}),a.questionTemp.answers.push({name:"Женский"}),a.questionTemp.name="Ваш пол",a.isSex="sex"==b.index),"age"==b.index&&(a.questionTemp.name="В какой интервал попадает Ваш возраст?",a.isAge="age"==b.index))}),a.$watchCollection("testTemp.questions",function(a,b){if(a.length!=b.length)for(var c=0;c<a.length;c++)a[c].indexOrder=c+1}),a.$watchCollection("questionTemp.answers",function(a,b){if(a.length!=b.length)for(var c=0;c<a.length;c++)a[c].linkIndexOrder=a[c].linkIndexOrder||1}),f.bootstrapSwitch().on("switchChange.bootstrapSwitch",function(b,c){a.$$phase?a.isView=!c:a.$apply(function(){a.isView=!c}),a.documentStateFirst?a.documentStateFirst=!1:a.revertEditTest(c)})}]),viewTest.service("testService",["$http",function(a){function b(a){var b="addTest",c={json:a.testTemp};return h(b,null,c)}function c(a){var b="deleteTest",c={testId:a};return h(b,c)}function d(a,b){return b?e(a):f(a)}function e(a){var b="confirmTest",c={testId:a};return h(b,c)}function f(a){var b="revertEditTest",c={testId:a};return h(b,c)}function g(a){a=a||"all";var b="getAllTests",c={documentState:a};return h(b,c)}function h(b,c,d){var e={method:"POST",url:b,dataType:"json",params:c,data:d},f=a(e);return f.error(errorRequest),f}return{addTest:b,deleteTest:c,getAllTests:g,revertEditTest:d}}]);var viewUser=angular.module("catiApp.viewUser",[]).config(["$routeProvider",function(a){a.when("/user",{templateUrl:"viewAdmin/viewUser/viewUser.html",controller:"ViewUserCtrl"})}]);viewUser.controller("ViewUserCtrl",["$scope","$rootScope","userService","ngTableParams",function(a,b,c,d){a.userList=[],a.modal={},a.modal.user=$("#newUserModal"),(a.getAllUsers=function(){c.getAllUsers().success(function(c){c&&c.result||b.dialogAlertOpen(),a.userList=angular.fromJson(c.result)})})(),a.saveUser=function(){c.addUser(a).success(function(c){c&&c.result||b.dialogAlertOpen(),a.getAllUsers(),a.modal.user.modal("hide")})},a.newUser=function(){a.clearUser(),a.modal.user.modal("show")},a.clearUser=function(){a.userTemp={}},a.editUser=function(b){a.userTemp=angular.copy(b),a.modal.user.modal("show")},a.removeUser=function(d,e){e.stopPropagation(),b.dialogConfirmOpen("Вы уверены, что хотите удалить интервьюера?",function(){c.removeUser(d).success(function(c){c&&c.result||b.dialogAlertOpen(),a.getAllUsers()})})},a.tableUserParams=new d({page:1,count:10},{total:a.userList.length,getData:function(b,c){var d=c.page(),e=c.count();a.tableUserParams.total(a.userList.length),b.resolve(a.userList.slice((d-1)*e,d*e))}}),a.tableUserParams.settings().$scope=a,a.$watchCollection("userList",function(b){b&&a.tableUserParams.reload()})}]),viewUser.service("userService",["$http",function(a){function b(a){var b="addUser",c={data:a.userTemp};return e(b,c)}function c(a){var b="inActivateUser",c={userId:a};return e(b,c)}function d(){var a="getAllUsers",b={role:"operator"};return e(a,b)}function e(b,c,d){var e={method:"POST",url:b,params:c,data:d},f=a(e);return f.error(errorRequest),f}return{addUser:b,removeUser:c,getAllUsers:d}}]);var viewStat=angular.module("catiApp.viewStat",[]).config(["$routeProvider",function(a){a.when("/stat/",{templateUrl:"viewAdmin/viewStat/viewStat.html",controller:"ViewStatCtrl"})}]);viewStat.controller("ViewStatCtrl",["$rootScope","$scope","pollService","statService","ngTableParams",function(a,b,c,d,e){b.type="test",b.pollList=[],b.userList=[],b.quotaPlan=[],b.callInfo=[],b.resultAnswer=[],b.quota=[],b.modal={},b.countRefresh=0,b.modal.view=$("#viewResultModal"),(b.getAllInterviews=function(){c.getAllInterviews().success(function(c){c&&c.result||a.dialogAlertOpen(),b.pollList=angular.fromJson(c.result)})})(),b.getUsersForInterview=function(){var c=angular.copy(b.userTemp);d.getUsersForInterview(b).success(function(d){d&&d.result||a.dialogAlertOpen(),b.userList=angular.fromJson(d.result),b.userList.unshift({}),b.userTemp=b.userList[0],console.log(c,b.userTemp),angular.equals(c,{})&&angular.equals(c,b.userTemp)&&(b.getResultInterviewCountStat(),b.getResultInterviewListStat())})},b.getResultInterviewCountStat=function(){b.pollTemp&&b.pollTemp.id&&d.getResultInterviewCountStat(b).success(function(c){c&&c.result||a.dialogAlertOpen(),b.quotaPlan=angular.fromJson(c.result)})},b.getResultInterviewListStat=function(){b.pollTemp&&b.pollTemp.id&&d.getResultInterviewListStat(b).success(function(c){c&&c.result||a.dialogAlertOpen(),b.callInfo=angular.fromJson(c.result)})},b.getSelectUserName=function(a){return a&&a.login?a.fio+" ("+a.login+")":"Все"},b.tableInfoParams=new e({page:1,count:10},{total:b.callInfo.length,getData:function(a,c){b.tableInfoParams.total(b.callInfo.length),a.resolve(b.callInfo.slice((c.page()-1)*c.count(),c.page()*c.count()))}}),b.tableInfoParams.settings().$scope=b,b.$watchCollection("callInfo",function(a){a&&b.tableInfoParams.reload()}),b.tableResultParams=new e({page:1,count:10},{total:b.resultAnswer.length,getData:function(a,c){b.tableResultParams.total(b.resultAnswer.length),a.resolve(b.resultAnswer.slice((c.page()-1)*c.count(),c.page()*c.count()))}}),b.tableResultParams.settings().$scope=b,b.$watchCollection("resultAnswer",function(a){a&&b.tableResultParams.reload()}),b.openViewResultModal=function(c){d.allAnswersByResultInterview(c).success(function(c){c&&c.result||a.dialogAlertOpen(),b.resultAnswer=angular.fromJson(c.result),b.modal.view.modal("show")})},b.$watch("pollTemp",function(a){a&&b.getUsersForInterview()},!0),b.$watch("userTemp",function(){b.getResultInterviewCountStat(),b.getResultInterviewListStat()},!0),b.$watch("quotaPlan",function(a){a&&(b.quota.totalCount=a.maleCount+a.femaleCount,b.quota.completedTotalCount=a.completedMaleCount+a.completedFemaleCount,b.quota.completedTotalPercent=Math.round(b.quota.completedTotalCount/b.quota.totalCount*100))},!0)}]),viewStat.service("statService",["$http",function(a){function b(a){var b="allAnswersByResultInterview",c={};return c.resultInterviewId=a,f(b,c)}function c(a){var b="getResultInterviewListStat",c={};return c.interviewId=a.pollTemp.id,c.userId=a.userTemp?a.userTemp.id:null,f(b,c)}function d(a){var b="getResultInterviewCountStat",c={};return c.interviewId=a.pollTemp.id,c.userId=a.userTemp?a.userTemp.id:null,f(b,c)}function e(a){var b="getUsersForInterview",c={};return c.interviewId=a.pollTemp.id,f(b,c)}function f(b,c){var d={method:"POST",url:b,params:c},e=a(d);return e.error(errorRequest),e}return{getUsersForInterview:e,getResultInterviewListStat:c,getResultInterviewCountStat:d,allAnswersByResultInterview:b}}]),angular.module("catiApp",["ngRoute","ngTable","ui.bootstrap","ui.bootstrap-slider","catiApp.view404","catiApp.viewMain","catiApp.viewTest","catiApp.viewPoll","catiApp.viewUser","catiApp.viewCurrent","catiApp.viewImport","catiApp.viewStat"]).config(["$routeProvider",function(a){a.when("/",{redirectTo:"/main"}),a.when("/404",{redirectTo:"/404"}),a.otherwise({redirectTo:"/404"})}]).controller("AppCtrl",["$rootScope","$scope","$location","appService",function(a,b,c,d){b.confirmText,b.alertText,b.confirmModal=$("#confirmModal"),b.alertModal=$("#alertModal"),b.waitModal=$("#waitModal"),b.progress={},b.progress.count=0,b.pollActive=!1,a.viewReviews=[],a.viewReviewId=0,a.getLocationPath=function(){return c.path()},a.setLocationPath=function(a){c.path(a)},a.isActiveMark=function(b,c){return a.isComparePath(b)?"activeMark"+c:""},b.catiDialogAlert=function(){b.alertModal.modal("hide")},b.dialogAlert=function(a,c){b.catiDialogAlert=function(){null!=c&&c(),b.alertModal.modal("hide")},b.alertText=a,b.alertModal.modal("show")},b.dialogConfirm=function(a,c){b.catiDialogConfirm=function(){c&&c(),b.confirmModal.modal("hide")},b.confirmText=a,b.confirmModal.modal("show")},a.findJsonObjects=function(b,c,d){var e=[];for(var f in b)b.hasOwnProperty(f)&&("object"==typeof b[f]?e=e.concat(a.findJsonObjects(b[f],c,d)):f==c&&b[c]==d&&e.push(b));return e},a.findJsonObjectsFirstLevel=function(a,b,c){for(var d=[],e=0;e<a.length;e++)a[e][b]==c&&d.push(a[e]);return d},a.dialogConfirmOpen=function(a,c){b.dialogConfirm(a,c)},a.dialogAlertOpen=function(a,c){b.dialogAlert(a,c)},a.dialogWaitingOpen=function(a,c){b.progress.title=a,b.progress.finish=c,b.startProgressBar(),b.waitModal.modal("show")},a.setWaitingFinish=function(a){b.progress.finish=a},a.dialogWaitingClose=function(){a.stopProgressBar(),b.waitModal.modal("hide"),b.progress.intervalId=null,b.progress.count=0},b.startProgressBar=function(){b.progress.intervalId||(b.progress.intervalId=setInterval(function(){b.getProgressBar(),b.progress.count>=100&&a.stopProgressBar()},1e3))},b.getProgressBar=function(){d.getProgressBar().success(function(c){c&&c.result||a.dialogAlertOpen(),b.progress.count=parseFloat(c.result)})},a.stopProgressBar=function(){clearInterval(b.progress.intervalId)},a.isComparePath=function(a){return c.path().substr(0,a.length)===a}}]).directive("numbersOnly",function(){return function(a,b,c){var d="true"===c.numonly;$(b[0]).numericInput({allowFloat:!d})}}).service("appService",["$http",function(a){function b(){var a="getProgressBar";return d(a)}function c(a){var b="getProperties",c={};return c.typeNum=a,d(b,c)}function d(b,c){var d={method:"POST",url:b,params:c},e=a(d);return e.error(errorRequest),e}return{getProgressBar:b,getProperties:c}}]);