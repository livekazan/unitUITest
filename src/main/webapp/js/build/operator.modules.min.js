"use strict";function pad(a,b){for(var c=""+a;c.length<b;)c="0"+c;return c}function formatTime(a){{var b=parseInt(a/60),c=parseInt(a/1)-60*b;pad(a-1e3*c-6e4*b,2)}return(b>0?pad(b,2):"00")+":"+pad(c,2)}function errorRequest(){$("#alertModal").modal("show")}function getAngularScope(){var a='body[ng-controller="AppCtrl"]',b=angular.element($(a)).scope();return b}function statusChangedApplet(a){var b=getAngularScope();b.statusChangedApplet(a),b.$$phase||b.$apply()}function setCallNumberApplet(a){var b=getAngularScope();b.setCallNumberApplet(a),b.$$phase||b.$apply()}function uploadStarted(){var a=getAngularScope();a.uploadStarted(),a.$$phase||a.$apply()}function uploadEnded(){var a=getAngularScope();a.uploadEnded(),a.$$phase||a.$apply()}var view404=angular.module("catiApp.view404",["ngRoute"]);view404.config(["$routeProvider",function(a){a.when("/404",{templateUrl:"view404/view404.html",controller:"Ctrl404"})}]),view404.controller("Ctrl404",[,function(){}]);var viewCurrent=angular.module("catiApp.viewCurrent",[]).config(["$routeProvider",function(a){a.when("/current",{templateUrl:"viewOperator/viewCurr/viewCurrent.html",controller:"ViewCurrentCtrl"})}]);viewCurrent.controller("ViewCurrentCtrl",["$scope","$rootScope","currService",function(a,b,c){a.currPollPage=-1,a.disabledNext=!1,a.contact={},a.currTest={},a.currPoll={},a.currQuestion={},a.resultInterviewJSON={},a.resultInterviewJSON.resultAnswerJSONs=[],a.disabledFinishBtn=!1,b.initializeInterview().success(function(c){c&&c.result||b.dialogAlertOpen();var d=angular.fromJson(c.result);d.errorMessage?b.dialogAlertOpen(d.errorMessage):(a.currPoll=d,a.currTest=d.testJSON,a.currPollPage=0,a.disabledNext=!1,b.setViewReviewId(a.currPoll.id),a.contact=b.pollResult.contact,a.resultInterviewJSON=b.pollResult)}),a.$watch("currPollPage",function(b){b>=0&&b<a.currTest.questions.length&&(a.currQuestion=a.currTest.questions[b])}),a.startQuestion=function(){a.endedText="",a.currPollPage=0,a.disabledFinishBtn=!1},a.prevQuestion=function(){a.currPollPage>0&&a.currPollPage--},a.checkAnswerTemp=function(){var a=[];return $(".checkAnswerTemp").each(function(){$(this).prop("checked")&&a.push(parseInt($(this).val()))}),a},a.nextQuestion=function(){if(a.disabledNext!==!0&&a.currPollPage<a.currTest.questions.length){var d,e=$("#radioAnswerTemp:checked"),f=a.checkAnswerTemp(),g=e.val(),h={};if(h.questionId=a.currQuestion.id,h.answerIds="multiple"==a.currQuestion.questionType?a.checkAnswerTemp():[parseInt(g)],b.pollRun){if(0==f.length&&!g)return void b.dialogAlertOpen("Выберите вариант ответа");var i=b.findJsonObjectsFirstLevel(a.resultInterviewJSON.resultAnswerJSONs,"id",h.questionId)[0];i||a.resultInterviewJSON.resultAnswerJSONs.push(h),a.disabledNext=!0,c.saveResultInterview(a).success(function(c){c&&c.result||b.dialogAlertOpen();var e=angular.fromJson(c.result);e.errorMessage?(b.dialogAlertOpen(e.errorMessage),9==e.errorCode&&(a.setEndedText(e.errorMessage),b.setResultPollStateQuota(),a.currPollPage=a.currTest.questions.length)):(a.resultInterviewJSON.id=c.result,d=b.findJsonObjectsFirstLevel(a.currQuestion.answers,"id",h.answerIds[0])[0],a.currPollPage=d&&"tree"==a.currQuestion.questionType?d.linkIndexOrder-1:a.currPollPage+1,a.disabledNext=!1,$("body,html").animate({scrollTop:0},200),a.currPollPage>=a.currTest.questions.length&&b.setResultPollStateEnded())})}else d=b.findJsonObjectsFirstLevel(a.currQuestion.answers,"id",h.answerIds[0])[0],a.currPollPage=d&&"tree"==a.currQuestion.questionType?d.linkIndexOrder-1:a.currPollPage+1,$("body,html").animate({scrollTop:0},200)}},a.setEndedText=function(b){a.endedText=b},a.removeInterviewFromList=function(c){b.viewReviews.splice(c,1),b.viewReviewId=b.viewReviews.length?b.viewReviews[0].id:0,a.initializeInterview()},a.getTextClass=function(b){return"text-"+a.getTypeClass(b)},a.stopPoll=function(){a.disabledFinishBtn=!0,b.stopCall()},a.getTypeClass=function(a){var b={isEdited:"info",isRunning:"success",isEnded:"danger"};return b[a]||"info"},b.initializeInterview=a.initializeInterview,b.removeInterviewFromList=a.removeInterviewFromList}]),viewCurrent.service("currService",["$http",function(a){function b(a){var b="saveResultInterview",c={json:a.resultInterviewJSON};return e(b,null,c)}function c(){var a="beginResultInterview";return e(a)}function d(){var a="getAvailableInterview";return e(a)}function e(b,c,d){var e={method:"POST",url:b,params:c,data:d},f=a(e);return f.error(errorRequest),f}return{saveResultInterview:b,beginResultInterview:c,getAvailableInterview:d}}]);var viewMain=angular.module("catiApp.viewMain",[]).config(["$routeProvider",function(a){a.when("/main",{templateUrl:"viewOperator/viewMain/viewMain.html",controller:"ViewMainCtrl"})}]);viewMain.controller("ViewMainCtrl",["$rootScope","$scope","mainService",function(a,b){function c(){b.quota.totalNumber=0,b.quota.currTotalNumber=0,b.quota.currTotalNumberPercent=0,b.quota.maleTotalNumber=0,b.quota.maleCurrTotalNumber=0,b.quota.maleCurrTotalNumberPercent=0,b.quota.femaleTotalNumber=0,b.quota.femaleCurrTotalNumber=0,b.quota.femaleCurrTotalNumberPercent=0}b.currTest={},b.currPoll={},b.quotaPlan={},b.quota={},c(),a.initializeInterview().success(function(c){c&&c.result||a.dialogAlertOpen();var d=angular.fromJson(c.result);d.errorMessage?a.dialogAlertOpen(d.errorMessage):(b.currPoll=d,b.quotaPlan=b.currPoll.quotaPlanJSON)}),b.startPoll=function(){a.startPoll()},b.$watch("quotaPlan",function(a){a&&a.id&&(c(),b.quota.femaleNumber=a.femaleNumber,b.quota.maleNumber=a.maleNumber,angular.forEach(a.quotaList,function(a){b.quota.totalNumber=b.quota.totalNumber+a.neededValue,b.quota.currTotalNumber=b.quota.currTotalNumber+a.completedValue,"male"===a.sex&&(b.quota.maleTotalNumber=b.quota.maleTotalNumber+a.neededValue,b.quota.maleCurrTotalNumber=b.quota.maleCurrTotalNumber+a.completedValue),"female"===a.sex&&(b.quota.femaleTotalNumber=b.quota.femaleTotalNumber+a.neededValue,b.quota.femaleCurrTotalNumber=b.quota.femaleCurrTotalNumber+a.completedValue)}),b.quota.currTotalNumberPercent=100*b.quota.currTotalNumber/b.quota.totalNumber,b.quota.maleCurrTotalNumberPercent=100*b.quota.maleCurrTotalNumber/b.quota.maleTotalNumber,b.quota.femaleCurrTotalNumberPercent=100*b.quota.femaleCurrTotalNumber/b.quota.femaleTotalNumber)},!0)}]),viewMain.service("mainService",["$http",function(a){return{}}]),angular.module("catiApp",["ngRoute","ui.bootstrap","timer","catiApp.view404","catiApp.viewMain","catiApp.viewCurrent"]).config(["$routeProvider",function(a){a.when("/",{redirectTo:"/main"}),a.when("/404",{redirectTo:"/404"}),a.otherwise({redirectTo:"/404"})}]).controller("AppCtrl",["$rootScope","$scope","$location","currService","appService",function(a,b,c,d,e){b.confirmText,b.alertText,b.confirmModal=$("#confirmModal"),b.skypeModal=$("#skypeModal"),b.alertModal=$("#alertModal"),b.waitModal=$("#waitModal"),b.currentNumber,b.currPoll={},b.pollActive=!1,b.resultInterviewId=0,b.resultInterviewState=[],a.pollResult={},a.appletParam={},a.pollRun=!1,a.uploadFile=!1,a.viewReviews=[],a.viewReviewId=0,(b.defaultSkype=function(){b.skype={},b.skype.text="",b.skype.contact={},b.skype.closeView=!0,b.skype.recallView=!1,b.skype.stopView=!1,b.skype.manualView=!1,b.skype.applet=document.jsk,b.skype.status={RINGING:"Соединение...",ROUTING:"Набор номера...",EARLYMEDIA:"Ожидание ответа...",CANCELLED:"Отменен...",REFUSED:"Абонент занят...",BUSY:"Абонент занят...",INPROGRESS:"Начало разговора",FINISHED:"Разговор закончен",FAILED:"Ошибка набора номера",skypeError:"Ошибка приложения"}})(),a.setVisibleButton=function(a,c,d,e){b.skype.closeView=d,b.skype.recallView=a,b.skype.stopView=c,b.skype.manualView=e},b.dialogSkype=function(a){b.skype.text=a,b.skypeModal.modal("show")},a.dialogSkypeOpen=function(a){b.pollStateTemp=null,b.dialogSkype(a)},a.dialogSkypeClose=function(){b.skypeModal.modal("hide")},a.pollFinished=function(){e.changeDocumentStateResultInterview(b,a.pollResult.id).success(function(c){c&&c.result||a.dialogAlertOpen();var d=angular.fromJson(c.result);d.errorMessage?a.dialogAlertOpen(d.errorMessage):(a.pollRun=!1,b.skypeModal.modal("hide"),a.setLocationPath("/main"))})},a.recallContact=function(){b.skype.statusText=b.skype.status.RINGING,b.skype.applet.makeCall(""+b.skype.contact.number)},a.manualConnection=function(){b.skype.applet.manualConnect()},a.setInitParams=function(a){var c=a.jsessionid,d=a.id,e="uploadRecordFile",f=a.url;b.skype.applet.setInitParams(f,c,e,d)},b.statusChangedApplet=function(c){if(console.log(c),b.skype.statusText=b.skype.status[c],"RINGING"==c||"ROUTING"==c||"EARLYMEDIA"==c||"UNPLACED"==c)b.skype.text="Вызываемый абонент: "+b.skype.contact.number,a.setVisibleButton(!1,!1,!1,!0),a.dialogSkypeOpen();else if("CANCELLED"==c||"FINISHED"==c||"REFUSED"==c||"BUSY"==c){if("null"==b.currentNumber||b.skype.contact.number!=b.currentNumber)return void a.dialogSkypeClose();a.setVisibleButton(!0,!0,!1),"FINISHED"==c&&"isEnded"==b.pollStateTemp?a.pollFinished():"FINISHED"==c&&"isQuotaOverflow"==b.pollStateTemp?a.pollFinished():a.dialogSkypeOpen()}else if("INPROGRESS"==c){if("null"===b.currentNumber||b.skype.contact.number!=b.currentNumber)return;a.pollRun=!0,a.dialogSkypeClose(),a.setLocationPath("/current"),a.setResultPollStateClear()}else"skypeError"==c?(a.setVisibleButton(!1,!1,!0),a.dialogSkypeOpen(),b.skype.text="Ошибка соединения со Skype. Возможно программа не запущена. Для повторной попытки соединения перегрузите страницу."):"FAILED"==c?(a.setVisibleButton(!1,!1,!0),a.dialogSkypeOpen(),b.skype.text="Возможно набираемый номер содержит неверный формат"):(a.setVisibleButton(!1,!1,!0),a.dialogSkypeOpen("Неизвестный статус Skype: "+c))},b.initializeInterview=function(){return d.getAvailableInterview()},(a.getProperties=function(){e.getProperties(6).success(function(c){c&&c.result||a.dialogAlertOpen();var d=angular.fromJson(c.result);if(d.errorMessage)a.dialogAlertOpen(d.errorMessage);else{b.resultPollState=d;{var e=a.findJsonObjectsFirstLevel(b.resultPollState,"index","all")[0],f=a.findJsonObjectsFirstLevel(b.resultPollState,"index","isRunning")[0];a.findJsonObjectsFirstLevel(b.resultPollState,"index","isEnded")[0]}b.resultPollState.splice(b.resultPollState.indexOf(e),1),b.resultPollState.splice(b.resultPollState.indexOf(f),1)}})})(),a.setResultPollStateEnded=function(){var c=a.findJsonObjectsFirstLevel(b.resultPollState,"index","isEnded")[0];b.pollStateTemp=c.index},a.setResultPollStateQuota=function(){var c=a.findJsonObjectsFirstLevel(b.resultPollState,"index","isQuotaOverflow")[0];b.pollStateTemp=c.index},a.setResultPollStateClear=function(){b.pollStateTemp=null},a.startPoll=function(){a.setVisibleButton(!1,!1,!0,!0),a.dialogSkypeOpen("Идет набор номера"),d.beginResultInterview().success(function(c){c&&c.result||a.dialogAlertOpen();var d=angular.fromJson(c.result);d.errorMessage?(a.dialogAlertOpen(d.errorMessage),a.dialogSkypeClose()):(a.pollResult=d,a.isPollStateDisabled=!1,b.skype.contact=angular.copy(d.contact),a.setInitParams(a.pollResult),a.recallContact())})},a.stopCall=function(){b.skype.applet.stopCall()},a.setCallNumberApplet=function(a){b.currentNumber=a},a.uploadStarted=function(){a.uploadFile=!0,a.dialogWaitingOpen()},a.uploadEnded=function(){a.uploadFile=!1,a.dialogWaitingClose()},a.statusChangedApplet=b.statusChangedApplet,a.getLocationPath=function(){return c.path()},a.setLocationPath=function(b){a.getLocationPath()!=b&&c.path(b)},a.setViewReviewId=function(a){b.resultInterviewId=a},a.isActiveMark=function(b,c){return a.isComparePath(b)?"activeMark"+c:""},b.catiDialogAlert=function(){b.alertModal.modal("hide")},b.dialogAlert=function(a,c){b.catiDialogAlert=function(){null!=c&&c(),b.alertModal.modal("hide")},b.alertText=a,b.alertModal.modal("show")},b.dialogConfirm=function(a,c){b.catiDialogConfirm=function(){c&&c(),b.confirmModal.modal("hide")},b.confirmText=a,b.confirmModal.modal("show")},a.findJsonObjects=function(b,c,d){var e=[];for(var f in b)b.hasOwnProperty(f)&&("object"==typeof b[f]?e=e.concat(a.findJsonObjects(b[f],c,d)):f==c&&b[c]==d&&e.push(b));return e},a.findJsonObjectsFirstLevel=function(a,b,c){for(var d=[],e=0;e<a.length;e++)a[e][b]==c&&d.push(a[e]);return d},a.dialogConfirmOpen=function(a,c){b.dialogConfirm(a,c)},a.dialogAlertOpen=function(a,c){b.dialogAlert(a,c)},a.dialogWaitingOpen=function(){b.waitModal.modal("show")},a.dialogWaitingClose=function(){b.waitModal.modal("hide")},a.isComparePath=function(a){return c.path()==a},a.initializeInterview=b.initializeInterview}]).service("appService",["$http",function(a){function b(a){var b="getOperatorProperties",c={};return c.typeNum=a,d(b,c)}function c(a,b){var c="changeDocumentStateResultInterview",e={};return e.resultInterviewId=b,e.resultInterviewState=a.pollStateTemp,e.comment=a.resultComment,d(c,e)}function d(b,c,d){var e={method:"POST",url:b,params:c,data:d},f=a(e);return f.error(errorRequest),f}return{getProperties:b,changeDocumentStateResultInterview:c}}]);